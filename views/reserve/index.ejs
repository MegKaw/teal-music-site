<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>体験レッスン予約 - 空き状況</title>
  <link rel="stylesheet" href="/css/style.css" />
  <style>
    main { max-width: 960px; margin: 24px auto; padding: 0 16px; }

    .course-intro {
      margin-bottom: 16px;
      font-size: 14px;
      color: #555;
    }

    .course-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 24px;
    }

    .course-btn {
      display: inline-block;
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid #0ea5e9;
      background: #e0f2fe;
      text-decoration: none;
      font-size: 14px;
      color: #0f172a;
      white-space: nowrap;
    }

    .course-btn.active {
      background: #0ea5e9;
      color: #fff;
    }

    .week-nav {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:16px;
      gap:8px;
      flex-wrap:wrap;
    }
    .week-nav a {
      padding:6px 10px;
      border-radius:999px;
      border:1px solid #ddd;
      text-decoration:none;
      font-size:14px;
    }

    .course-label {
      font-size:14px;
      color:#555;
      margin-bottom:8px;
    }

    .week-grid {
      display:grid;
      gap:12px;
      grid-template-columns:repeat(auto-fit,minmax(120px,1fr));
    }
    .day-col {
      border:1px solid #eee;
      border-radius:10px;
      padding:8px;
      background:#fff;
    }
    .day-head {
      font-weight:700;
      font-size:14px;
      margin-bottom:6px;
    }
    .slot-btn {
      width:100%;
      margin:4px 0;
      padding:6px 8px;
      border-radius:8px;
      border:1px solid #ddd;
      font-size:13px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      cursor:pointer;
      background:#fff;
    }
    .slot-btn.free {
      border-color:#16a34a;
      color:#166534;
      background:#ecfdf3;
    }
    .slot-btn.full {
      border-color:#ccc;
      color:#777;
      background:#f5f5f5;
      cursor:not-allowed;
    }
    .slot-btn span.mark { font-weight:700; }

    .no-slot {
      font-size:13px;
      color:#aaa;
      padding:12px 4px;
      text-align:center;
    }
  </style>
</head>
<body>
  <%- include('../partials/header') %>

  <main>
    <h1>体験レッスン予約</h1>

    <%
      // コース一覧（IDは /reserve?course=◯ で使う値）
      const courseList = [
        { id: 'vocal',   label: 'ボーカル' },
        { id: 'guitar',  label: 'ギター' },
        { id: 'bass',    label: 'ベース' },
        { id: 'ukulele', label: 'ウクレレ' },
        { id: 'dtm',     label: 'DTM' },
        { id: 'musical', label: 'ミュージカル / 声楽' }
      ];

      const findCourseLabel = (id) => {
        const item = courseList.find(c => c.id === id);
        return item ? item.label : id;
      };

      const fmtDate = (d) => {
        const dt = new Date(d);
        const w = ['日','月','火','水','木','金','土'][dt.getDay()];
        return `${dt.getMonth()+1}/${dt.getDate()}(${w})`;
      };
      const toParam = (d) => {
        const dt = new Date(d);
        const y = dt.getFullYear();
        const m = String(dt.getMonth()+1).padStart(2,'0');
        const day = String(dt.getDate()).padStart(2,'0');
        return `${y}-${m}-${day}`;
      };
      const prevWeek = new Date(monday); prevWeek.setDate(monday.getDate()-7);
      const nextWeek = new Date(monday); nextWeek.setDate(monday.getDate()+7);
    %>

    <!-- コース選択ブロック -->
    <div class="course-intro">
      ご希望のコースを選んで、体験レッスンの空き枠をご確認ください。
    </div>

    <div class="course-buttons">
      <% courseList.forEach(function(c){ %>
        <a
          href="/reserve?<%= `course=${encodeURIComponent(c.id)}` %>"
          class="course-btn <%= course === c.id ? 'active' : '' %>"
        >
          <%= c.label %>
        </a>
      <% }) %>
    </div>

    <% if (!course) { %>
      <!-- コース未選択時：カレンダーはまだ出さない -->
      <p style="font-size:13px;color:#777;">
        コースを選択すると、1週間分の空き状況が表示されます。
      </p>
    <% } else { %>
      <!-- コース選択済み：週カレンダー表示 -->
      <div class="course-label">
        コース：<strong><%= findCourseLabel(course) %></strong>
      </div>

      <div class="week-nav">
        <a href="/reserve?<%=
          `date=${toParam(prevWeek)}&course=${encodeURIComponent(course)}`
        %>">← 前の週</a>

        <div>
          <strong><%= fmtDate(monday) %> 〜 <%= fmtDate(sunday) %></strong>
        </div>

        <a href="/reserve?<%=
          `date=${toParam(nextWeek)}&course=${encodeURIComponent(course)}`
        %>">次の週 →</a>
      </div>

      <div class="week-grid">
        <% days.forEach(function(day){ %>
          <div class="day-col">
            <div class="day-head"><%= fmtDate(day.date) %></div>

            <% if (!day.slots || day.slots.length === 0) { %>
              <div class="no-slot">空き枠なし</div>
            <% } else { %>
              <% day.slots.forEach(function(slot){ %>
                <form method="GET" action="/reserve/form">
                  <input type="hidden" name="slotId" value="<%= slot._id %>">
                  <input type="hidden" name="course" value="<%= course || '' %>">
                  <input type="hidden" name="type" value="trial">

                  <button
                    type="submit"
                    class="slot-btn <%= slot.canBook ? 'free' : 'full' %>"
                    <%= slot.canBook ? '' : 'disabled' %>
                  >
                    <span><%= slot.startTime %>〜<%= slot.endTime %></span>
                    <span class="mark"><%= slot.canBook ? '◯' : '×' %></span>
                  </button>
                </form>
                        
              <% }) %>
            <% } %>
          </div>
        <% }) %>
      </div>
    <% } %>
    <p style="margin-top:24px; font-size:12px; color:#6b7280; text-align:right;">
      管理者の方は
      <a href="/reserve/admin-login" style="text-decoration:underline;">
        既存生徒用予約システムにログイン
      </a>
    </p>
  </main>

  <%- include('../partials/footer') %>
  <script src="/js/main.js"></script>
</body>
</html>
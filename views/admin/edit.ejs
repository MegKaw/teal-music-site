<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>記事の編集</title>
  <link rel="stylesheet" href="/css/style.css">
  <link href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css" rel="stylesheet">
</head>
<body>
  <h1>記事の編集</h1>

  <form id="postForm" class="admin-form" action="/admin/posts/<%= post._id %>/update" method="POST">

    <!-- タイトル -->
    <div class="field">
      <label for="title">タイトル</label>
      <input type="text" id="title" name="title" value="<%= post.title || '' %>" required>
    </div>

    <!-- カテゴリ -->
    <div class="field">
      <label for="category">カテゴリー</label>
      <select id="category" name="category" required>
        <option value="">選択してください</option>
        <option value="vocal"   <%= post.category === 'vocal'   ? 'selected' : '' %>>ボーカル</option>
        <option value="guitar"  <%= post.category === 'guitar'  ? 'selected' : '' %>>ギター</option>
        <option value="dtm"     <%= post.category === 'dtm'     ? 'selected' : '' %>>DTM</option>
        <option value="bass"    <%= post.category === 'bass'    ? 'selected' : '' %>>ベース</option>
        <option value="ukulele" <%= post.category === 'ukulele' ? 'selected' : '' %>>ウクレレ</option>
        <option value="musical" <%= post.category === 'musical' ? 'selected' : '' %>>ミュージカル・声楽</option>
        <option value="news"    <%= post.category === 'news'    ? 'selected' : '' %>>NEWS</option>
      </select>
    </div>

    <!-- サムネイルURL -->
    <div class="field">
      <label for="coverImage">サムネイルURL</label>
      <input type="text" id="coverImage" name="coverImage" value="<%= post.coverImage || '' %>">
      <div style="margin-top:8px;display:flex;align-items:center;gap:8px">
        <input type="file" id="coverFile" accept="image/*">
        <button type="button" id="coverUploadBtn">画像をアップロード</button>
      </div>
      <div class="thumb-preview">
        <% if (post.coverImage) { %>
          <img src="<%= post.coverImage %>" style="width:200px;border-radius:8px;">
        <% } %>
      </div>
    </div>

    <!-- 本文 -->
    <div class="field">
      <label>本文</label>
      <div id="editor"></div>
      <input type="hidden" id="contentField" name="content" value="">
    </div>

    <!-- 概要・SEO -->
    <div class="field">
      <label for="excerpt">記事の概要</label>
      <textarea id="excerpt" name="excerpt" rows="3"><%= post.excerpt || '' %></textarea>
    </div>

    <div class="field">
      <label for="metaDescription">SEO説明文（任意）</label>
      <textarea id="metaDescription" name="metaDescription" rows="3"><%= post.metaDescription || post.excerpt || '' %></textarea>
    </div>

    <!-- ステータス -->
    <div class="field">
      <label>公開設定</label>
      <label><input type="radio" name="status" value="published" <%= post.status === 'published' ? 'checked' : '' %>> 公開</label>
      <label><input type="radio" name="status" value="draft" <%= post.status === 'draft' ? 'checked' : '' %>> 下書き</label>
    </div>

    <button type="submit">更新する</button>
  </form>

  <script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>
  <script>
  (function(){
    const form = document.getElementById('postForm');
    const hidden = document.getElementById('contentField');
    const toolbar = [
      ['bold','italic','underline','strike'],
      [{ header:[2,3,false] }],
      [{ list:'ordered' }, { list:'bullet' }],
      ['link','image'],
      ['clean']
    ];

    const quill = new Quill('#editor', {
      theme: 'snow',
      modules: { toolbar: { container: toolbar, handlers: { image: imageHandler } } }
    });

    // 本文の初期表示
    quill.root.innerHTML = <%- JSON.stringify(post.content || post.body || "") %>;

    form.addEventListener('submit', () => {
      hidden.value = quill.root.innerHTML || '';
    });

    async function imageHandler() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = async () => {
        const f = input.files?.[0];
        if (!f) return;
        const fd = new FormData();
        fd.append('image', f);
        try {
          const res = await fetch('/admin/uploads/images', {
            method: 'POST',
            body: fd,
            credentials: 'same-origin'
          });
          const ct = (res.headers.get('content-type') || '').toLowerCase();
          if (!ct.includes('application/json')) {
            throw new Error(`Upload failed (HTTP ${res.status})`);
          }
          const data = await res.json();
          if (!res.ok || !data?.url) throw new Error(data?.error || 'upload error');

          const sel = quill.getSelection(true) || { index: quill.getLength(), length: 0 };
          quill.insertEmbed(sel.index, 'image', data.url, 'user');
          quill.setSelection(sel.index + 1, 0);
        } catch (e) {
          alert('画像挿入失敗');
          console.error(e);
        }
      };
      input.click();
    }

    document.getElementById('coverUploadBtn').addEventListener('click', async () => {
      const f = document.getElementById('coverFile').files?.[0];
      if (!f) { alert('画像を選択してください'); return; }
      const fd = new FormData();
      fd.append('image', f);
      try {
        const res = await fetch('/admin/uploads/images', {
          method: 'POST',
          body: fd,
          credentials: 'same-origin'
        });
        const ct = (res.headers.get('content-type') || '').toLowerCase();
        if (!ct.includes('application/json')) {
          throw new Error(`アップロード失敗 (HTTP ${res.status})`);
        }
        const data = await res.json();
        if (!res.ok || !data?.url) throw new Error(data?.error || 'アップロード失敗');

        document.getElementById('coverImage').value = data.url;
        document.querySelector('.thumb-preview').innerHTML =
          `<img src="${data.url}" style="width:200px;border-radius:8px;">`;
      } catch (err) {
        alert(err.message);
        console.error(err);
      }
    });
  })();
  </script>

  <style>
    body { max-width: 960px; margin: 24px auto; font-family: system-ui, sans-serif; }
    .admin-form .field { margin: 12px 0; }
    input, select, textarea { width:100%; padding:8px; border:1px solid #ddd; border-radius:8px; }
    .thumb-preview img { width:200px; border-radius:8px; display:block; }
    .ql-editor img { max-width:100%; border-radius:6px; }
  </style>
</body>
</html>